<html><!-- Mirrored from developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Perfect_negotiation by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 14 Feb 2023 04:50:02 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="../../../../../favicon-48x48.cbbd161b.png"><link rel="apple-touch-icon" href="../../../../../apple-touch-icon.6803c6f0.png"><meta name="theme-color" content="#ffffff"><link rel="manifest" href="../../../../../manifest.56b1cedc.json"><link rel="search" type="application/opensearchdescription+xml" href="https://developer.mozilla.org/opensearch.xml" title="MDN Web Docs"><title>Establishing a connection: The WebRTC perfect negotiation pattern</title><meta name="robots" content="index, follow"><meta name="description" content="This article introduces WebRTC perfect negotiation, describing how it works and why it's the recommended way to negotiate a WebRTC connection between peers, and provides sample code to demonstrate the technique."><meta property="og:url" content="Perfect_negotiation.html"><meta property="og:title" content="Establishing a connection: The WebRTC perfect negotiation pattern - Web APIs | MDN"><meta property="og:locale" content="en-US"><meta property="og:description" content="This article introduces WebRTC perfect negotiation, describing how it works and why it's the recommended way to negotiate a WebRTC connection between peers, and provides sample code to demonstrate the technique."><meta property="og:image" content="../../../../../mdn-social-share.cd6c4a5a.png"><meta property="twitter:card" content="summary_large_image"><link rel="canonical" href="Perfect_negotiation.html"><style media="print">.article-actions-container,.document-toc-container,.language-menu,.main-menu-toggle,.mdn-cta-container,.on-github,.page-footer,.sidebar,.top-navigation-main,ul.prev-next{display:none!important}.main-page-content,.main-page-content pre{padding:2px}.main-page-content pre{border-left-width:2px}</style><script src="../../../../../static/js/ga.js" defer=""></script><script defer="defer" src="../../../../../static/js/main.5c9d40d0.js"></script><link href="../../../../../static/css/main.7d378400.css" rel="stylesheet"></head><body><script>document.body.addEventListener("load",(t=>{t.target.classList.contains("interactive")&&t.target.setAttribute("data-readystate","complete")}),{capture:!0});const c={light:"#ffffff",dark:"#1b1b1b"};if(window&&document.documentElement)try{const t=window.localStorage.getItem("theme");t&&(document.documentElement.className=t,document.documentElement.style.backgroundColor=c[t])}catch(t){console.warn("Unable to read theme from localStorage",t)}</script><div id="root"><ul id="nav-access" class="a11y-nav"><li><a id="skip-main" href="#content">Skip to main content</a></li><li><a id="skip-search" href="#top-nav-search-input">Skip to search</a></li><li><a id="skip-select-language" href="#languages-switcher-button">Skip to select language</a></li></ul><div class="page-wrapper  category-api document-page"><div class="main-document-header-container"><header class="main-document-header-container top-navigation 
      
      "><div class="container "><div class="top-navigation-wrap"><a href="https://developer.mozilla.org/en-US/" class="logo" aria-label="MDN homepage"><svg id="mdn-docs-logo" xmlns="http://www.w3.org/2000/svg" x="0" y="0" viewBox="0 0 694.9 104.4" style="enable-background:new 0 0 694.9 104.4" xml:space="preserve" role="img"><title>MDN Web Docs</title><style>.logo-m{fill:var(--text-link)}</style><g class="logo-m"><path d="M40.3 0 11.7 92.1H0L28.5 0h11.8zM50.7 0v92.1H40.3V0h10.4zM91 0 62.5 92.1H50.8L79.3 0H91zM101.4 0v92.1H91V0h10.4z"></path></g><path class="logo-m" d="M627.9 95.6h67v8.8h-67v-8.8z"></path><g style="fill:var(--text-primary)"><path d="M367 42h-4l-10.7 30.8h-5.5l-10.8-26h-.4l-10.5 26h-5.2L308.7 42h-3.8v-5.6H323V42h-6.5l6.8 20.4h.4l10.3-26h4.7l11.2 26h.5l5.7-20.3h-6.2v-5.6H367V42zM401.9 62c-.4 3.2-2 5.9-4.7 8.2-2.8 2.3-6.5 3.4-11.3 3.4-5.4 0-9.7-1.6-13.1-4.7-3.3-3.2-5-7.7-5-13.7 0-5.7 1.6-10.3 4.7-14s7.4-5.5 12.9-5.5c5.1 0 9.1 1.6 11.9 4.7s4.3 6.9 4.3 11.3c0 1.5-.2 3-.5 4.7h-25.6c.3 7.7 4 11.6 10.9 11.6 2.9 0 5.1-.7 6.5-2 1.5-1.4 2.5-3 3-4.9l6 .9zM394 51.3c.2-2.4-.4-4.7-1.8-6.9s-3.8-3.3-7-3.3c-3.1 0-5.3 1-6.9 3-1.5 2-2.5 4.4-2.8 7.2H394zM445 53.7c0 5-1.3 9.5-4 13.7s-6.9 6.2-12.7 6.2c-6 0-10.3-2.2-12.7-6.7-.1.4-.2 1.4-.4 2.9s-.3 2.5-.4 2.9h-7.3c.3-1.7.6-3.5.8-5.3.3-1.8.4-3.7.4-5.5V22.3h-6v-5.6H416v27c1.1-2.2 2.7-4.1 4.7-5.7 2-1.6 4.8-2.4 8.4-2.4 4.6 0 8.4 1.6 11.4 4.7 3 3.2 4.5 7.6 4.5 13.4zm-7.7.6c0-4.2-1-7.4-3-9.5-2-2.2-4.4-3.3-7.4-3.3-3.4 0-6 1.2-8 3.7-1.9 2.4-2.9 5-3 7.7V57c0 3 1 5.6 3 7.7s4.5 3.1 7.6 3.1c3.6 0 6.3-1.3 8.1-3.9 1.8-2.7 2.7-5.9 2.7-9.6zM506.5 72.8h-13.2v-7.2c-1.2 2.2-2.8 4.1-4.9 5.6-2.1 1.6-4.8 2.4-8.3 2.4-4.8 0-8.7-1.6-11.6-4.9-2.9-3.2-4.3-7.7-4.3-13.3 0-5 1.3-9.6 4-13.7 2.6-4.1 6.9-6.2 12.8-6.2 5.7 0 9.8 2.2 12.3 6.5V22.3h-8.6v-5.6h15.8v50.6h6v5.5zM493.2 56v-4.4c-.1-3-1.2-5.5-3.2-7.3s-4.4-2.8-7.2-2.8c-3.6 0-6.3 1.3-8.2 3.9-1.9 2.6-2.8 5.8-2.8 9.6 0 4.1 1 7.3 3 9.5s4.5 3.3 7.4 3.3c3.2 0 5.8-1.3 7.8-3.8 2.1-2.6 3.1-5.3 3.2-8zM546.3 54.6c0 5.6-1.8 10.2-5.3 13.7s-8.2 5.3-13.9 5.3-10.1-1.7-13.4-5.1c-3.3-3.4-5-7.9-5-13.5 0-5.3 1.6-9.9 4.7-13.7 3.2-3.8 7.9-5.7 14.2-5.7s11 1.9 14.1 5.7c3 3.7 4.6 8.1 4.6 13.3zm-7.7-.2c0-4-1-7.2-3-9.5s-4.8-3.5-8.2-3.5c-3.6 0-6.4 1.2-8.3 3.7s-2.9 5.6-2.9 9.5c0 3.7.9 6.8 2.8 9.4 1.9 2.6 4.6 3.9 8.3 3.9 3.6 0 6.4-1.3 8.4-3.8 1.9-2.6 2.9-5.8 2.9-9.7zM583.6 60.2c-.4 3.2-1.9 6.3-4.4 9.1-2.5 2.9-6.4 4.3-11.8 4.3-5.2 0-9.4-1.6-12.6-4.8-3.2-3.2-4.8-7.7-4.8-13.7 0-5.5 1.6-10.1 4.7-13.9 3.2-3.8 7.6-5.7 13.2-5.7 2.3 0 4.6.3 6.7.8 2.2.5 4.2 1.5 6.2 2.9l1.5 9.5-5.9.7-1.3-6.1c-2.1-1.2-4.5-1.8-7.2-1.8-3.5 0-6.1 1.2-7.7 3.7-1.7 2.5-2.5 5.7-2.5 9.6 0 4.1.9 7.3 2.7 9.5 1.8 2.3 4.4 3.4 7.8 3.4 5.2 0 8.2-2.9 9.2-8.8l6.2 1.3zM618.3 62.1c0 3.6-1.5 6.5-4.6 8.5s-7 3-11.7 3c-5.7 0-10.6-1.2-14.6-3.6l1.2-8.8 5.7.6-.2 4.7c1.1.5 2.3.9 3.6 1.1s2.6.3 3.9.3c2.4 0 4.5-.4 6.5-1.3 1.9-.9 2.9-2.2 2.9-4.1 0-1.8-.8-3.1-2.3-3.8s-3.5-1.3-5.8-1.7-4.6-.9-6.9-1.4c-2.3-.6-4.2-1.6-5.7-2.9-1.6-1.4-2.3-3.5-2.3-6.3 0-4.1 1.5-6.9 4.6-8.5s6.4-2.4 9.9-2.4c2.6 0 5 .3 7.2.9 2.2.6 4.3 1.4 6.1 2.4l.8 8.8-5.8.7-.8-5.7c-2.3-1-4.7-1.6-7.2-1.6-2.1 0-3.7.4-5.1 1.1-1.3.8-2 2-2 3.8 0 1.7.8 2.9 2.3 3.6 1.5.7 3.4 1.2 5.7 1.6 2.2.4 4.5.8 6.7 1.4 2.2.6 4.1 1.6 5.7 3 1.4 1.6 2.2 3.7 2.2 6.6zM197.6 73.2h-17.1v-5.5h3.8V51.9c0-3.7-.7-6.3-2.1-7.9-1.4-1.6-3.3-2.3-5.7-2.3-3.2 0-5.6 1.1-7.2 3.4s-2.4 4.6-2.5 6.9v15.6h6v5.5h-17.1v-5.5h3.8V51.9c0-3.8-.7-6.4-2.1-7.9-1.4-1.5-3.3-2.3-5.6-2.3-3.2 0-5.5 1.1-7.2 3.3-1.6 2.2-2.4 4.5-2.5 6.9v15.8h6.9v5.5h-20.2v-5.5h6V42.4h-6.1v-5.6h13.4v6.4c1.2-2.1 2.7-3.8 4.7-5.2 2-1.3 4.4-2 7.3-2s5.3.7 7.5 2.1c2.2 1.4 3.7 3.5 4.5 6.4 1.1-2.5 2.7-4.5 4.9-6.1s4.8-2.4 7.9-2.4c3.5 0 6.5 1.1 8.9 3.3s3.7 5.6 3.7 10.2v18.2h6.1v5.5zm42.5 0h-13.2V66c-1.2 2.2-2.8 4.1-4.9 5.6-2.1 1.6-4.8 2.4-8.3 2.4-4.8 0-8.7-1.6-11.6-4.9-2.9-3.2-4.3-7.7-4.3-13.3 0-5 1.3-9.6 4-13.7 2.6-4.1 6.9-6.2 12.8-6.2s9.8 2.2 12.3 6.5V22.7h-8.6v-5.6h15.8v50.6h6v5.5zm-13.3-16.8V52c-.1-3-1.2-5.5-3.2-7.3s-4.4-2.8-7.2-2.8c-3.6 0-6.3 1.3-8.2 3.9-1.9 2.6-2.8 5.8-2.8 9.6 0 4.1 1 7.3 3 9.5s4.5 3.3 7.4 3.3c3.2 0 5.8-1.3 7.8-3.8 2.1-2.6 3.1-5.3 3.2-8zm61.5 16.8H269v-5.5h6V51.9c0-3.7-.7-6.3-2.2-7.9-1.4-1.6-3.4-2.3-5.7-2.3-3.1 0-5.6 1-7.4 3s-2.8 4.4-2.9 7v15.9h6v5.5h-19.3v-5.5h6V42.4h-6.2v-5.6h13.6V43c2.6-4.6 6.8-6.9 12.7-6.9 3.6 0 6.7 1.1 9.2 3.3s3.7 5.6 3.7 10.2v18.2h6v5.4h-.2z"></path></g></svg></a><button title="Open main menu" type="button" class="button action has-icon main-menu-toggle" aria-haspopup="menu" aria-label="Open main menu" aria-expanded="false"><span class="button-wrap"><span class="icon icon-menu "></span><span class="visually-hidden">Open main menu</span></span></button></div><div class="top-navigation-main"><nav class="main-nav" aria-label="Main menu"><ul class="main-menu nojs"><li class="top-level-entry-container"><button type="button" id="references-button" class="top-level-entry menu-toggle" aria-controls="references-menu" aria-expanded="false">References</button><a href="https://developer.mozilla.org/en-US/docs/Web" class="top-level-entry">References</a><ul id="references-menu" class="submenu references hidden inline-submenu-lg" aria-labelledby="references-button"><li class="apis-link-container mobile-only "><a href="https://developer.mozilla.org/en-US/docs/Web" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Overview / Web Technology</div><p class="submenu-item-description">Web technology reference for developers</p></div></a></li><li class="html-link-container "><a href="https://developer.mozilla.org/en-US/docs/Web/HTML" class="submenu-item "><div class="submenu-icon html"></div><div class="submenu-content-container"><div class="submenu-item-heading">HTML</div><p class="submenu-item-description">Structure of content on the web</p></div></a></li><li class="css-link-container "><a href="https://developer.mozilla.org/en-US/docs/Web/CSS" class="submenu-item "><div class="submenu-icon css"></div><div class="submenu-content-container"><div class="submenu-item-heading">CSS</div><p class="submenu-item-description">Code used to describe document style</p></div></a></li><li class="javascript-link-container "><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" class="submenu-item "><div class="submenu-icon javascript"></div><div class="submenu-content-container"><div class="submenu-item-heading">JavaScript</div><p class="submenu-item-description">General-purpose scripting language</p></div></a></li><li class="http-link-container "><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP" class="submenu-item "><div class="submenu-icon http"></div><div class="submenu-content-container"><div class="submenu-item-heading">HTTP</div><p class="submenu-item-description">Protocol for transmitting web resources</p></div></a></li><li class="apis-link-container "><a href="../../API.html" class="submenu-item "><div class="submenu-icon apis"></div><div class="submenu-content-container"><div class="submenu-item-heading">Web APIs</div><p class="submenu-item-description">Interfaces for building web applications</p></div></a></li><li class="apis-link-container "><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Web Extensions</div><p class="submenu-item-description">Developing extensions for web browsers</p></div></a></li><li class="apis-link-container desktop-only "><a href="https://developer.mozilla.org/en-US/docs/Web" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Web Technology</div><p class="submenu-item-description">Web technology reference for developers</p></div></a></li></ul></li><li class="top-level-entry-container"><button type="button" id="guides-button" class="top-level-entry menu-toggle" aria-controls="guides-menu" aria-expanded="false">Guides</button><a href="https://developer.mozilla.org/en-US/docs/Learn" class="top-level-entry">Guides</a><ul id="guides-menu" class="submenu guides hidden inline-submenu-lg" aria-labelledby="guides-button"><li class="apis-link-container mobile-only "><a href="https://developer.mozilla.org/en-US/docs/Learn" class="submenu-item "><div class="submenu-icon learn"></div><div class="submenu-content-container"><div class="submenu-item-heading">Overview / MDN Learning Area</div><p class="submenu-item-description">Learn web development</p></div></a></li><li class="apis-link-container desktop-only "><a href="https://developer.mozilla.org/en-US/docs/Learn" class="submenu-item "><div class="submenu-icon learn"></div><div class="submenu-content-container"><div class="submenu-item-heading">MDN Learning Area</div><p class="submenu-item-description">Learn web development</p></div></a></li><li class="html-link-container "><a href="https://developer.mozilla.org/en-US/docs/Learn/HTML" class="submenu-item "><div class="submenu-icon html"></div><div class="submenu-content-container"><div class="submenu-item-heading">HTML</div><p class="submenu-item-description">Learn to structure web content with HTML</p></div></a></li><li class="css-link-container "><a href="https://developer.mozilla.org/en-US/docs/Learn/CSS" class="submenu-item "><div class="submenu-icon css"></div><div class="submenu-content-container"><div class="submenu-item-heading">CSS</div><p class="submenu-item-description">Learn to style content using CSS</p></div></a></li><li class="javascript-link-container "><a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript" class="submenu-item "><div class="submenu-icon javascript"></div><div class="submenu-content-container"><div class="submenu-item-heading">JavaScript</div><p class="submenu-item-description">Learn to run scripts in the browser</p></div></a></li><li class=" "><a href="https://developer.mozilla.org/en-US/docs/Web/Accessibility" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Accessibility</div><p class="submenu-item-description">Learn to make the web accessible to all</p></div></a></li></ul></li><li class="top-level-entry-container"><button type="button" id="mdn-plus-button" class="top-level-entry menu-toggle" aria-controls="mdn-plus-menu" aria-expanded="false">MDN Plus</button><a href="https://developer.mozilla.org/en-US/plus" class="top-level-entry">MDN Plus</a><ul id="mdn-plus-menu" class="submenu mdn-plus hidden inline-submenu-lg" aria-labelledby="mdn-plus-button"><li class=" "><a href="https://developer.mozilla.org/en-US/plus" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Overview</div><p class="submenu-item-description">A customized MDN experience</p></div></a></li><li class=" "><a href="https://developer.mozilla.org/en-US/plus/updates" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Updates</div><p class="submenu-item-description">All browser compatibility updates at a glance</p></div></a></li><li class=" "><a href="https://developer.mozilla.org/en-US/plus/docs/features/overview" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">Documentation</div><p class="submenu-item-description">Learn how to use MDN Plus</p></div></a></li><li class=" "><a href="https://developer.mozilla.org/en-US/plus/docs/faq" class="submenu-item "><div class="submenu-icon"></div><div class="submenu-content-container"><div class="submenu-item-heading">FAQ</div><p class="submenu-item-description">Frequently asked questions about MDN Plus</p></div></a></li></ul></li></ul></nav><div class="header-search"><form action="https://developer.mozilla.org/en-US/search" role="search" aria-haspopup="listbox" aria-owns="top-nav-search-menu" aria-expanded="false" class="search-form search-widget" id="top-nav-search-form"><label id="top-nav-search-label" for="top-nav-search-input" class="visually-hidden">Search MDN</label><input id="top-nav-search-input" aria-autocomplete="list" aria-controls="top-nav-search-menu" aria-labelledby="top-nav-search-label" autocomplete="off" type="search" class="search-input-field" name="q" placeholder="   " required="" value=""><button type="button" class="button action has-icon clear-search-button"><span class="button-wrap"><span class="icon icon-cancel "></span><span class="visually-hidden">Clear search input</span></span></button><button type="submit" class="button action has-icon search-button"><span class="button-wrap"><span class="icon icon-search "></span><span class="visually-hidden">Search</span></span></button><div id="top-nav-search-menu" role="listbox" aria-labelledby="top-nav-search-label"></div></form></div><div class="theme-switcher-menu"><button type="button" class="button action has-icon theme-switcher-menu small" aria-haspopup="menu"><span class="button-wrap"><span class="icon icon-theme-os-default "></span>Theme</span></button></div><ul class="auth-container"><li><a href="https://developer.mozilla.org/users/fxa/login/authenticate/?next=%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWebRTC_API%2FPerfect_negotiation" class="signin-link" rel="nofollow">Already a subscriber?</a></li><li><a class="button primary mdn-plus-subscribe-link" href="https://developer.mozilla.org/en-US/plus"><span class="button-wrap">Get MDN Plus</span></a></li></ul></div></div></header><div class="article-actions-container"><div class="container"><button type="button" class="button action has-icon sidebar-button" aria-label="Expand sidebar" aria-expanded="false" aria-controls="sidebar-quicklinks"><span class="button-wrap"><span class="icon icon-sidebar "></span></span></button><nav class="breadcrumbs-container" aria-label="Breadcrumb"><ol typeof="BreadcrumbList" vocab="https://schema.org/" aria-label="breadcrumbs"><li property="itemListElement" typeof="ListItem"><a class="breadcrumb" property="item" typeof="WebPage" href="https://developer.mozilla.org/en-US/docs/Web"><span property="name">References</span></a><meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem"><a class="breadcrumb" property="item" typeof="WebPage" href="../../API.html"><span property="name">Web APIs</span></a><meta property="position" content="2"></li><li property="itemListElement" typeof="ListItem"><a class="breadcrumb" property="item" typeof="WebPage" href="../WebRTC_API.html"><span property="name">WebRTC API</span></a><meta property="position" content="3"></li><li property="itemListElement" typeof="ListItem"><a class="breadcrumb-current-page" property="item" typeof="WebPage" href="Perfect_negotiation.html"><span property="name">Establishing a connection: The WebRTC perfect negotiation pattern</span></a><meta property="position" content="4"></li></ol></nav></div></div></div><div class="main-wrapper"><aside id="sidebar-quicklinks" class="sidebar"><button type="button" class="button action backdrop" aria-label="Collapse sidebar"><span class="button-wrap"></span></button><nav aria-label="Related Topics" class="sidebar-inner"><div class="in-nav-toc"><div class="document-toc-container"><section class="document-toc"><header><h2 class="document-toc-heading">In this article</h2></header><ul class="document-toc-list"><li class="document-toc-item "><a class="document-toc-link" href="#perfect_negotiation_concepts">Perfect negotiation concepts</a></li><li class="document-toc-item "><a class="document-toc-link" href="#implementing_perfect_negotiation">Implementing perfect negotiation</a></li><li class="document-toc-item "><a class="document-toc-link" href="#making_negotiation_perfect">Making negotiation perfect</a></li><li class="document-toc-item "><a class="document-toc-link" href="#see_also">See also</a></li></ul></section></div></div><div><ol><li><strong><a href="../WebRTC_API.html">WebRTC API</a></strong></li><li class="toggle"><details open=""><summary>Guides</summary><ol><li><a href="Protocols.html">Introduction to WebRTC protocols</a></li><li><a href="Connectivity.html">WebRTC connectivity</a></li><li><a href="Session_lifetime.html">Lifetime of a WebRTC session</a></li><li><a href="Signaling_and_video_calling.html">Signaling and video calling</a></li><li><a href="Using_data_channels.html">Using WebRTC data channels</a></li><li><a href="Using_DTMF.html">Using DTMF with WebRTC</a></li><li><a href="../WebRTC_API.html#interoperability">WebRTC API</a></li><li><a href="Simple_RTCDataChannel_sample.html">A simple RTCDataChannel sample</a></li><li><a href="Build_a_phone_with_peerjs.html">Building an Internet-Connected Phone with PeerJS</a></li></ol></details></li><li class="toggle"><details open=""><summary>Interfaces</summary><ol><li><a href="../RTCPeerConnection.html"><code>RTCPeerConnection</code></a></li><li><a href="../RTCSessionDescription.html"><code>RTCSessionDescription</code></a></li><li><a href="../RTCIceCandidate.html"><code>RTCIceCandidate</code></a></li><li><a href="../RTCPeerConnectionIceEvent.html"><code>RTCPeerConnectionIceEvent</code></a></li><li><a href="../RTCPeerConnectionIceErrorEvent.html"><code>RTCPeerConnectionIceErrorEvent</code></a></li><li><a href="../RTCCertificate.html"><code>RTCCertificate</code></a></li><li><a href="../RTCRtpSender.html"><code>RTCRtpSender</code></a></li><li><a href="../RTCRtpReceiver.html"><code>RTCRtpReceiver</code></a></li><li><a href="../RTCRtpTransceiver.html"><code>RTCRtpTransceiver</code></a></li><li><a href="../RTCDtlsTransport.html"><code>RTCDtlsTransport</code></a></li><li><a href="../RTCIceTransport.html"><code>RTCIceTransport</code></a></li><li><a href="../RTCTrackEvent.html"><code>RTCTrackEvent</code></a></li><li><a href="../RTCSctpTransport.html"><code>RTCSctpTransport</code></a></li><li><a href="../RTCDataChannel.html"><code>RTCDataChannel</code></a></li><li><a href="../RTCDataChannelEvent.html"><code>RTCDataChannelEvent</code></a></li><li><a href="../RTCDTMFSender.html"><code>RTCDTMFSender</code></a></li><li><a href="../RTCDTMFToneChangeEvent.html"><code>RTCDTMFToneChangeEvent</code></a></li><li><a href="../RTCStatsReport.html"><code>RTCStatsReport</code></a></li><li><a href="../RTCErrorEvent.html"><code>RTCErrorEvent</code></a></li></ol></details></li><li class="toggle"><details open=""><summary>Properties</summary><ol><li><a href="../Navigator/mediaDevices.html"><code>Navigator.mediaDevices</code></a></li></ol></details></li><li class="toggle"><details open=""><summary>Methods</summary><ol><li><a href="../MediaDevices/getUserMedia.html"><code>MediaDevices.getUserMedia()</code></a></li></ol></details></li><li class="toggle"><details open=""><summary>Events</summary><ol><li><a href="../RTCDTMFSender/tonechange_event.html"><code>RTCDTMFSender</code>: <code>tonechange</code></a></li><li><a href="../RTCDataChannel/bufferedamountlow_event.html"><code>RTCDataChannel</code>: <code>bufferedamountlow</code></a></li><li><a href="../RTCDataChannel/close_event.html"><code>RTCDataChannel</code>: <code>close</code></a></li><li><a href="../RTCDataChannel/closing_event.html"><code>RTCDataChannel</code>: <code>closing</code></a></li><li><a href="../RTCDataChannel/error_event.html"><code>RTCDataChannel</code>: <code>error</code></a></li><li><a href="../RTCDataChannel/message_event.html"><code>RTCDataChannel</code>: <code>message</code></a></li><li><a href="../RTCDataChannel/open_event.html"><code>RTCDataChannel</code>: <code>open</code></a></li><li><a href="../RTCDtlsTransport/error_event.html"><code>RTCDtlsTransport</code>: <code>error</code></a></li><li><a href="../RTCDtlsTransport/statechange_event.html"><code>RTCDtlsTransport</code>: <code>statechange</code></a></li><li><a href="../RTCIceTransport/error_event.html"><code>RTCIceTransport</code>: <code>error</code></a></li><li><a href="../RTCIceTransport/gatheringstatechange_event.html"><code>RTCIceTransport</code>: <code>gatheringstatechange</code></a></li><li><a href="../RTCIceTransport/selectedcandidatepairchange_event.html"><code>RTCIceTransport</code>: <code>selectedcandidatepairchange</code></a></li><li><a href="../RTCIceTransport/statechange_event.html"><code>RTCIceTransport</code>: <code>statechange</code></a></li><li><a href="../RTCPeerConnection/connectionstatechange_event.html"><code>RTCPeerConnection</code>: <code>connectionstatechange</code></a></li><li><a href="../RTCPeerConnection/datachannel_event.html"><code>RTCPeerConnection</code>: <code>datachannel</code></a></li><li><a href="../RTCPeerConnection/icecandidate_event.html"><code>RTCPeerConnection</code>: <code>icecandidate</code></a></li><li><a href="../RTCPeerConnection/icecandidateerror_event.html"><code>RTCPeerConnection</code>: <code>icecandidateerror</code></a></li><li><a href="../RTCPeerConnection/iceconnectionstatechange_event.html"><code>RTCPeerConnection</code>: <code>iceconnectionstatechange</code></a></li><li><a href="../RTCPeerConnection/icegatheringstatechange_event.html"><code>RTCPeerConnection</code>: <code>icegatheringstatechange</code></a></li><li><a href="../RTCPeerConnection/negotiationneeded_event.html"><code>RTCPeerConnection</code>: <code>negotiationneeded</code></a></li><li><a href="../RTCPeerConnection/signalingstatechange_event.html"><code>RTCPeerConnection</code>: <code>signalingstatechange</code></a></li><li><a href="../RTCPeerConnection/track_event.html"><code>RTCPeerConnection</code>: <code>track</code></a></li><li><a href="../RTCSctpTransport/error_event.html"><code>RTCSctpTransport</code>: <code>error</code></a></li></ol></details></li></ol></div></nav></aside><aside class="toc"><nav><div class="document-toc-container"><section class="document-toc"><header><h2 class="document-toc-heading">In this article</h2></header><ul class="document-toc-list"><li class="document-toc-item "><a class="document-toc-link" href="#perfect_negotiation_concepts">Perfect negotiation concepts</a></li><li class="document-toc-item "><a class="document-toc-link" href="#implementing_perfect_negotiation">Implementing perfect negotiation</a></li><li class="document-toc-item "><a class="document-toc-link" href="#making_negotiation_perfect">Making negotiation perfect</a></li><li class="document-toc-item "><a class="document-toc-link" href="#see_also">See also</a></li></ul></section></div></nav></aside><main id="content" class="main-content  "><article class="main-page-content" lang="en-US"><h1>Establishing a connection: The WebRTC perfect negotiation pattern</h1><div class="section-content"><p>This article introduces WebRTC <strong>perfect negotiation</strong>, describing how it works and why it's the recommended way to negotiate a WebRTC connection between peers, and provides sample code to demonstrate the technique.</p>
<p>Because <a href="../WebRTC_API.html">WebRTC</a> doesn't mandate a specific transport mechanism for signaling during the negotiation of a new peer connection, it's highly flexible. However, despite that flexibility in transport and communication of signaling messages, there's still a recommended design pattern you should follow when possible, known as perfect negotiation.</p>
<p>After the first deployments of WebRTC-capable browsers, it was realized that parts of the negotiation process were more complicated than they needed to be for typical use cases. This was due to a small number of issues with the API and some potential race conditions that needed to be prevented. These issues have since been addressed, letting us simplify our WebRTC negotiation significantly. The perfect negotiation pattern is an example of the ways in which negotiation have improved since the early days of WebRTC.</p></div><section aria-labelledby="perfect_negotiation_concepts"><a class="dashAnchor" name="//apple_ref/Section/Perfect%20negotiation%20concepts"></a><h2 id="perfect_negotiation_concepts"><a href="#perfect_negotiation_concepts">Perfect negotiation concepts</a></h2><div class="section-content"><p>Perfect negotiation makes it possible to seamlessly and completely separate the negotiation process from the rest of your application's logic. Negotiation is an inherently asymmetric operation: one side needs to serve as the "caller" while the other peer is the "callee." The perfect negotiation pattern smooths this difference away by separating that difference out into independent negotiation logic, so that your application doesn't need to care which end of the connection it is. As far as your application is concerned, it makes no difference whether you're calling out or receiving a call.</p>
<p>The best thing about perfect negotiation is that the same code is used for both the caller and the callee, so there's no repetition or otherwise added levels of negotiation code to write.</p>
<p>Perfect negotiation works by assigning each of the two peers a role to play in the negotiation process that's entirely separate from the WebRTC connection state:</p>
<ul>
  <li>A <strong>polite</strong> peer, which uses ICE rollback to prevent collisions with incoming offers. A polite peer, essentially, is one which may send out offers, but then responds if an offer arrives from the other peer with "Okay, never mind, drop my offer and I'll consider yours instead."</li>
  <li>An <strong>impolite</strong> peer, which always ignores incoming offers that collide with its own offers. It never apologizes or gives up anything to the polite peer. Any time a collision occurs, the impolite peer wins.</li>
</ul>
<p>This way, both peers know exactly what should happen if there are collisions between offers that have been sent. Responses to error conditions become far more predictable.</p>
<p>How you determine which peer is polite and which is impolite is generally up to you. It could be as simple as assigning the polite role to the first peer to connect to the signaling server, or you could do something more elaborate like having the peers exchange random numbers and assigning the polite role to the winner. However you make the determination, once these roles are assigned to the two peers, they can then work together to manage signaling in a way that doesn't deadlock and doesn't require a lot of extra code to manage.</p>
<p>An important thing to keep in mind is this: the roles of caller and callee can switch during perfect negotiation. If the polite peer is the caller and it sends an offer but there's a collision with the impolite peer, the polite peer drops its offer and instead replies to the offer it has received from the impolite peer. By doing so, the polite peer has switched from being the caller to the callee!</p></div></section><section aria-labelledby="implementing_perfect_negotiation"><a class="dashAnchor" name="//apple_ref/Section/Implementing%20perfect%20negotiation"></a><h2 id="implementing_perfect_negotiation"><a href="#implementing_perfect_negotiation">Implementing perfect negotiation</a></h2><div class="section-content"><p>Let's take a look at an example that implements the perfect negotiation pattern. The code assumes that there's a <code>SignalingChannel</code> class defined that is used to communicate with the signaling server. Your own code, of course, can use any signaling technique you like.</p>
<p>Note that this code is identical for both peers involved in the connection.</p></div></section><section aria-labelledby="create_the_signaling_and_peer_connections"><h3 id="create_the_signaling_and_peer_connections"><a href="#create_the_signaling_and_peer_connections">Create the signaling and peer connections</a></h3><div class="section-content"><p>First, the signaling channel needs to be opened and the <a href="../RTCPeerConnection.html"><code>RTCPeerConnection</code></a> needs to be created. The <a href="https://developer.mozilla.org/en-US/docs/Glossary/STUN">STUN</a> server listed here is obviously not a real one; you'll need to replace <code>stun.myserver.tld</code> with the address of a real STUN server.</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">iceServers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">urls</span><span class="token operator">:</span> <span class="token string">"stun:stun.mystunserver.tld"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> signaler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignalingChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>This code also gets the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video"><code>&lt;video&gt;</code></a> elements using the classes "selfview" and "remoteview"; these will contain, respectively, the local user's self-view and the view of the incoming stream from the remote peer.</p></div></section><section aria-labelledby="connecting_to_a_remote_peer"><h3 id="connecting_to_a_remote_peer"><a href="#connecting_to_a_remote_peer">Connecting to a remote peer</a></h3><div class="section-content"><div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">const</span> constraints <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">audio</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">video</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> selfVideo <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"video.selfview"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> remoteVideo <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"video.remoteview"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>mediaDevices<span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span>constraints<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> track <span class="token keyword">of</span> stream<span class="token punctuation">.</span><span class="token function">getTracks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pc<span class="token punctuation">.</span><span class="token function">addTrack</span><span class="token punctuation">(</span>track<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    selfVideo<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> stream<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The <code>start()</code> function shown above can be called by either of the two end-points that want to talk to one another. It doesn't matter who does it first; the negotiation will just work.</p>
<p>This isn't appreciably different from older WebRTC connection establishment code. The user's camera and microphone are obtained by calling <a href="../MediaDevices/getUserMedia.html" title="getUserMedia()"><code>getUserMedia()</code></a>. The resulting media tracks are then added to the <a href="../RTCPeerConnection.html"><code>RTCPeerConnection</code></a> by passing them into <a href="../RTCPeerConnection/addTrack.html" title="addTrack()"><code>addTrack()</code></a>. Then, finally, the media source for the self-view <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video"><code>&lt;video&gt;</code></a> element indicated by the <code>selfVideo</code> constant is set to the camera and microphone stream, allowing the local user to see what the other peer sees.</p></div></section><section aria-labelledby="handling_incoming_tracks"><h3 id="handling_incoming_tracks"><a href="#handling_incoming_tracks">Handling incoming tracks</a></h3><div class="section-content"><p>We next need to set up a handler for <a href="../RTCPeerConnection/track_event.html" title="track"><code>track</code></a> events to handle inbound video and audio tracks that have been negotiated to be received by this peer connection. To do this, we implement the <a href="../RTCPeerConnection.html"><code>RTCPeerConnection</code></a>'s <a href="../RTCPeerConnection/track_event.html" title="ontrack"><code>ontrack</code></a> event handler.</p>
<div class="code-example"><pre class="brush: js notranslate"><code>pc<span class="token punctuation">.</span><span class="token function-variable function">ontrack</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> track<span class="token punctuation">,</span> streams <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  track<span class="token punctuation">.</span><span class="token function-variable function">onunmute</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>remoteVideo<span class="token punctuation">.</span>srcObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    remoteVideo<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> streams<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p>When the <code>track</code> event occurs, this handler executes. Using <a href="../../JavaScript/Reference/Operators/Destructuring_assignment.html">destructuring</a>, the <a href="../RTCTrackEvent.html"><code>RTCTrackEvent</code></a>'s <a href="../RTCTrackEvent/track.html" title="track"><code>track</code></a> and <a href="../RTCTrackEvent/streams.html" title="streams"><code>streams</code></a> properties are extracted. The former is either the video track or the audio track being received. The latter is an array of <a href="../MediaStream.html"><code>MediaStream</code></a> objects, each representing a stream containing this track (a track may in rare cases belong to multiple streams at once). In our case, this will always contain one stream, at index 0, because we passed one stream into <code>addTrack()</code> earlier.</p>
<p>We add an unmute event handler to the track, because the track will become unmuted once it starts receiving packets. We put the remainder of our reception code in there.</p>
<p>If we already have video coming in from the remote peer (which we can see if the remote view's <code>&lt;video&gt;</code> element's <a href="../HTMLMediaElement/srcObject.html" title="srcObject"><code>srcObject</code></a> property already has a value), we do nothing. Otherwise, we set <code>srcObject</code> to the stream at index 0 in the <code>streams</code> array.</p></div></section><section aria-labelledby="the_perfect_negotiation_logic"><h3 id="the_perfect_negotiation_logic"><a href="#the_perfect_negotiation_logic">The perfect negotiation logic</a></h3><div class="section-content"><p>Now we get into the true perfect negotiation logic, which functions entirely independently from the rest of the application.</p>
<h4 id="handling_the_negotiationneeded_event">Handling the negotiationneeded event</h4>
<p>First, we implement the <a href="../RTCPeerConnection.html"><code>RTCPeerConnection</code></a> event handler <a href="../RTCPeerConnection/negotiationneeded_event.html" title="onnegotiationneeded"><code>onnegotiationneeded</code></a> to get a local description and send it using the signaling channel to the remote peer.</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">let</span> makingOffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

pc<span class="token punctuation">.</span><span class="token function-variable function">onnegotiationneeded</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    makingOffer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    signaler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">description</span><span class="token operator">:</span> pc<span class="token punctuation">.</span>localDescription <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    makingOffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p>Note that <code>setLocalDescription()</code> without arguments automatically creates and sets the appropriate description based on the current <a href="../RTCPeerConnection/signalingState.html" title="signalingState"><code>signalingState</code></a>. The set description is either an answer to the most recent offer from the remote peer <em>or</em> a freshly-created offer if there's no negotiation underway. Here, it will always be an <code>offer</code>, because the negotiationneeded event is only fired in <code>stable</code> state.</p>
<p>We set a Boolean variable, <code>makingOffer</code> to <code>true</code> to mark that we're preparing an offer. To avoid races, we'll use this value later instead of the signaling state to determine whether or not an offer is being processed because the value of <a href="../RTCPeerConnection/signalingState.html" title="signalingState"><code>signalingState</code></a> changes asynchronously, introducing a glare opportunity.</p>
<p>Once the offer has been created, set and sent (or an error occurs), <code>makingOffer</code> gets set back to <code>false</code>.</p>
<h4 id="handling_incoming_ice_candidates">Handling incoming ICE candidates</h4>
<p>Next, we need to handle the <code>RTCPeerConnection</code> event <a href="../RTCPeerConnection/icecandidate_event.html" title="icecandidate"><code>icecandidate</code></a>, which is how the local ICE layer passes candidates to us for delivery to the remote peer over the signaling channel.</p>
<div class="code-example"><pre class="brush: js notranslate"><code>pc<span class="token punctuation">.</span><span class="token function-variable function">onicecandidate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> candidate <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> signaler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> candidate <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>This takes the <code>candidate</code> member of this ICE event and passes it through to the signaling channel's <code>send()</code> method to be sent over the signaling server to the remote peer.</p>
<h4 id="handling_incoming_messages_on_the_signaling_channel">Handling incoming messages on the signaling channel</h4>
<p>The last piece of the puzzle is code to handle incoming messages from the signaling server. That's implemented here as an <code>onmessage</code> event handler on the signaling channel object. This method is invoked each time a message arrives from the signaling server.</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">let</span> ignoreOffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

signaler<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> description<span class="token punctuation">,</span> candidate <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>description<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> offerCollision <span class="token operator">=</span>
        description<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"offer"</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>makingOffer <span class="token operator">||</span> pc<span class="token punctuation">.</span>signalingState <span class="token operator">!==</span> <span class="token string">"stable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      ignoreOffer <span class="token operator">=</span> <span class="token operator">!</span>polite <span class="token operator">&amp;&amp;</span> offerCollision<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoreOffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>description<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"offer"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        signaler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">description</span><span class="token operator">:</span> pc<span class="token punctuation">.</span>localDescription <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">addIceCandidate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ignoreOffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p>Upon receiving an incoming message from the <code>SignalingChannel</code> through its <code>onmessage</code> event handler, the received JSON object is destructured to obtain the <code>description</code> or <code>candidate</code> found within. If the incoming message has a <code>description</code>, it's either an offer or an answer sent by the other peer.</p>
<p>If, on the other hand, the message has a <code>candidate</code>, it's an ICE candidate received from the remote peer as part of <a href="../RTCPeerConnection/canTrickleIceCandidates.html">trickle ICE</a>. The candidate is destined to be delivered to the local ICE layer by passing it into <a href="../RTCPeerConnection/addIceCandidate.html" title="addIceCandidate()"><code>addIceCandidate()</code></a>.</p>
<h5 id="on_receiving_a_description">On receiving a description</h5>
<p>If we received a <code>description</code>, we prepare to respond to the incoming offer or answer. First, we check to make sure we're in a state in which we can accept an offer. If the connection's signaling state isn't <code>stable</code> or if our end of the connection has started the process of making its own offer, then we need to look out for offer collision.</p>
<p>If we're the impolite peer, and we're receiving a colliding offer, we return without setting the description, and instead set <code>ignoreOffer</code> to <code>true</code> to ensure we also ignore all candidates the other side may be sending us on the signaling channel belonging to this offer. Doing so avoids error noise since we never informed our side about this offer.</p>
<p>If we're the polite peer, and we're receiving a colliding offer, we don't need to do anything special, because our existing offer will automatically be rolled back in the next step.</p>
<p>Having ensured that we want to accept the offer, we set the remote description to the incoming offer by calling <a href="../RTCPeerConnection/setRemoteDescription.html" title="setRemoteDescription()"><code>setRemoteDescription()</code></a>. This lets WebRTC know what the proposed configuration of the other peer is. If we're the polite peer, we will drop our offer and accept the new one.</p>
<p>If the newly-set remote description is an offer, we ask WebRTC to select an appropriate local configuration by calling the <a href="../RTCPeerConnection.html"><code>RTCPeerConnection</code></a> method <a href="../RTCPeerConnection/setLocalDescription.html" title="setLocalDescription()"><code>setLocalDescription()</code></a> without parameters. This causes <code>setLocalDescription()</code> to automatically generate an appropriate answer in response to the received offer. Then we send the answer through the signaling channel back to the first peer.</p>
<h5 id="on_receiving_an_ice_candidate">On receiving an ICE candidate</h5>
<p>On the other hand, if the received message contains an ICE candidate, we deliver it to the local <a href="https://developer.mozilla.org/en-US/docs/Glossary/ICE">ICE</a> layer by calling the <a href="../RTCPeerConnection.html"><code>RTCPeerConnection</code></a> method <a href="../RTCPeerConnection/addIceCandidate.html" title="addIceCandidate()"><code>addIceCandidate()</code></a>. If an error occurs and we've ignored the most recent offer, we also ignore any error that may occur when trying to add the candidate.</p></div></section><section aria-labelledby="making_negotiation_perfect"><a class="dashAnchor" name="//apple_ref/Section/Making%20negotiation%20perfect"></a><h2 id="making_negotiation_perfect"><a href="#making_negotiation_perfect">Making negotiation perfect</a></h2><div class="section-content"><p>If you're curious what makes perfect negotiation <em>so perfect</em>, this section is for you. Here, we'll look at each change made to the WebRTC API and to best practice recommendations to make perfect negotiation possible.</p></div></section><section aria-labelledby="glare-free_setlocaldescription"><h3 id="glare-free_setlocaldescription"><a href="#glare-free_setlocaldescription">Glare-free setLocalDescription()</a></h3><div class="section-content"><p>In the past, the <a href="../RTCPeerConnection/negotiationneeded_event.html" title="negotiationneeded"><code>negotiationneeded</code></a> event was easily handled in a way that was susceptible to glare—that is, it was prone to collisions, where both peers could wind up attempting to make an offer at the same time, leading to one or the other peers getting an error and aborting the connection attempt.</p>
<h4 id="the_old_way">The old way</h4>
<p>Consider this <a href="../RTCPeerConnection/negotiationneeded_event.html" title="onnegotiationneeded"><code>onnegotiationneeded</code></a> event handler:</p>
<div class="code-example"><pre class="brush: js example-bad notranslate"><code>pc<span class="token punctuation">.</span><span class="token function-variable function">onnegotiationneeded</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    signaler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">description</span><span class="token operator">:</span> pc<span class="token punctuation">.</span>localDescription <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p>Because the <a href="../RTCPeerConnection/createOffer.html" title="createOffer()"><code>createOffer()</code></a> method is asynchronous and takes some time to complete, there's time in which the remote peer might attempt to send an offer of its own, causing us to leave the <code>stable</code> state and enter the <code>have-remote-offer</code> state, which means we are now waiting for a response to the offer. But once it receives the offer we just sent, so is the remote peer. This leaves both peers in a state in which the connection attempt cannot be completed.</p>
<h4 id="perfect_negotiation_with_the_updated_api">Perfect negotiation with the updated API</h4>
<p>As shown in the section <a href="#implementing_perfect_negotiation">Implementing perfect negotiation</a>, we can eliminate this problem by introducing a variable (here called <code>makingOffer</code>) which we use to indicate that we are in the process of sending an offer, and making use of the updated <code>setLocalDescription()</code> method:</p>
<div class="code-example"><pre class="brush: js example-good notranslate"><code><span class="token keyword">let</span> makingOffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

pc<span class="token punctuation">.</span><span class="token function-variable function">onnegotiationneeded</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    makingOffer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    signaler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">description</span><span class="token operator">:</span> pc<span class="token punctuation">.</span>localDescription <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    makingOffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p>We set <code>makingOffer</code> immediately before calling <code>setLocalDescription()</code> in order to lock against interfering with sending this offer, and we don't clear it back to <code>false</code> until the offer has been sent to the signaling server (or an error has occurred, preventing the offer from being made). This way, we avoid the risk of offers colliding.</p></div></section><section aria-labelledby="automatic_rollback_in_setremotedescription"><h3 id="automatic_rollback_in_setremotedescription"><a href="#automatic_rollback_in_setremotedescription">Automatic rollback in setRemoteDescription()</a></h3><div class="section-content"><p>A key component to perfect negotiation is the concept of the polite peer, which always rolls itself back if it receives an offer while itself waiting for an answer to an offer. Previously, triggering rollback involved manually checking for rollback conditions and triggering the rollback manually, by setting the local description to one with the type <code>rollback</code>, like this:</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"rollback"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>Doing so returns the local peer to the <code>stable</code> <a href="../RTCPeerConnection/signalingState.html" title="signalingState"><code>signalingState</code></a> from whichever state it had previously been in. Since a peer can only accept offers when in the <code>stable</code> state, the peer has thus rescinded its offer and is ready to receive the offer from the remote (impolite) peer. As we'll see in a moment, there are problems with this approach, however.</p>
<h4 id="perfect_negotiation_with_the_old_api">Perfect negotiation with the old API</h4>
<p>Using the previous API to implement incoming negotiation messages during perfect negotiation would look something like this:</p>
<div class="code-example"><pre class="brush: js example-bad notranslate"><code>signaler<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> description<span class="token punctuation">,</span> candidate <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>description<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>description<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"offer"</span> <span class="token operator">&amp;&amp;</span> pc<span class="token punctuation">.</span>signalingState <span class="token operator">!==</span> <span class="token string">"stable"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>polite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
          pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"rollback"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>description<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"offer"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">createAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        signaler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">description</span><span class="token operator">:</span> pc<span class="token punctuation">.</span>localDescription <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">addIceCandidate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ignoreOffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p>Since rollback works by postponing changes until the next negotiation (which will begin immediately after the current one is finished), the polite peer needs to know when it needs to throw away a received offer if it's currently waiting for a reply to an offer it's already sent.</p>
<p>The code checks to see if the message is an offer, and if so, if the local signaling state isn't <code>stable</code>. If it's not stable, <em>and</em> the local peer is the polite one, we need to trigger rollback so we can replace the outgoing offer with the new incoming one. And these must both be completed before we can proceed with handling the received offer.</p>
<p>Since there isn't a single "roll back and use this offer instead", performing this change on the polite peer requires two steps, executed in the context of <a href="../../JavaScript/Reference/Global_Objects/Promise/all.html"><code>Promise.all()</code></a>, which is used to ensure that both statements execute completely before continuing to handle the received offer. The first statement triggers rollback and the second sets the remote description to the received one, thus completing the process of replacing the previously <em>sent</em> offer with the newly <em>received</em> offer. The impolite peer has now become the callee instead of the caller.</p>
<p>All other descriptions received from the impolite peer are processed as normal, by passing them into <a href="../RTCPeerConnection/setRemoteDescription.html" title="setRemoteDescription()"><code>setRemoteDescription()</code></a>.</p>
<p>Finally, we process a received offer by calling <code>setLocalDescription()</code> to set our local description to the one returned by <a href="../RTCPeerConnection/createAnswer.html" title="createAnswer()"><code>createAnswer()</code></a>. Then that gets sent to the polite peer using the signaling channel.</p>
<p>If the incoming message is an ICE candidate rather than an SDP description, it's delivered to the ICE layer by passing it into the <a href="../RTCPeerConnection.html"><code>RTCPeerConnection</code></a> method <a href="../RTCPeerConnection/addIceCandidate.html" title="addIceCandidate()"><code>addIceCandidate()</code></a>. If an error occurs here and we didn't just discard an offer due to being the impolite peer during a collision, we <a href="../../JavaScript/Reference/Statements/throw.html"><code>throw</code></a> the error so the caller can handle it. Otherwise, we drop the error, ignoring it, since it doesn't matter in this context.</p>
<h4 id="perfect_negotiation_with_the_updated_api_2">Perfect negotiation with the updated API</h4>
<p>The updated code takes advantage of the fact that you can now call <a href="../RTCPeerConnection/setLocalDescription.html" title="setLocalDescription()"><code>setLocalDescription()</code></a> with no parameters so it just does the right thing for you, as well as the fact that <code>setRemoteDescription()</code> automatically rolls back if necessary. This lets us get rid of the need to use a <a href="../../JavaScript/Reference/Global_Objects/Promise.html"><code>Promise</code></a> to keep the timing in order, since the rollback becomes an essentially atomic part of the <code>setRemoteDescription()</code> call.</p>
<div class="code-example"><pre class="brush: js example-good notranslate"><code><span class="token keyword">let</span> ignoreOffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

signaler<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> description<span class="token punctuation">,</span> candidate <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>description<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> offerCollision <span class="token operator">=</span>
        description<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"offer"</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>makingOffer <span class="token operator">||</span> pc<span class="token punctuation">.</span>signalingState <span class="token operator">!==</span> <span class="token string">"stable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      ignoreOffer <span class="token operator">=</span> <span class="token operator">!</span>polite <span class="token operator">&amp;&amp;</span> offerCollision<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoreOffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>description<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"offer"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        signaler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">description</span><span class="token operator">:</span> pc<span class="token punctuation">.</span>localDescription <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">addIceCandidate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ignoreOffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p>While the difference in code size is minor, and the complexity isn't reduced much either, the code is much, much more reliable. Let's take a dive into the code to see how it works now.</p>
<h5 id="on_receiving_a_description_2">On receiving a description</h5>
<p>In the revised code, if the received message is an SDP <code>description</code>, we check to see if it arrived while we're attempting to transmit an offer. If the received message is an <code>offer</code> <em>and</em> the local peer is the impolite peer, <em>and</em> a collision is occurring, we ignore the offer because we want to continue to try to use the offer that's already in the process of being sent. That's the impolite peer in action.</p>
<p>In any other case, we'll try instead to handle the incoming message. This begins by setting the remote description to the received <code>description</code> by passing it into <a href="../RTCPeerConnection/setRemoteDescription.html" title="setRemoteDescription()"><code>setRemoteDescription()</code></a>. This works regardless of whether we're handling an offer or an answer since rollback will be performed automatically as needed.</p>
<p>At that point, if the received message is an <code>offer</code>, we use <code>setLocalDescription()</code> to create and set an appropriate local description, then we send it to the remote peer over the signaling server.</p>
<h5 id="on_receiving_an_ice_candidate_2">On receiving an ICE candidate</h5>
<p>On the other hand, if the received message is an ICE candidate—indicated by the JSON object containing a <code>candidate</code> member—we deliver it to the local ICE layer by calling the <a href="../RTCPeerConnection.html"><code>RTCPeerConnection</code></a> method <a href="../RTCPeerConnection/addIceCandidate.html" title="addIceCandidate()"><code>addIceCandidate()</code></a>. Errors are, as before, ignored if we have just discarded an offer.</p></div></section><section aria-labelledby="explicit_restartice_method_added"><h3 id="explicit_restartice_method_added"><a href="#explicit_restartice_method_added">Explicit restartIce() method added</a></h3><div class="section-content"><p>The techniques previously used to trigger an <a href="Session_lifetime.html#ice_restart">ICE restart</a> while handling the event <a href="../RTCPeerConnection/negotiationneeded_event.html" title="negotiationneeded"><code>negotiationneeded</code></a> have significant flaws. These flaws have made it difficult to safely and reliably trigger a restart during negotiation. The perfect negotiation improvements have fixed this by adding a new <a href="../RTCPeerConnection/restartIce.html" title="restartIce()"><code>restartIce()</code></a> method to <code>RTCPeerConnection</code>.</p>
<h4 id="the_old_way_2">The old way</h4>
<p>In the past, if you encountered an ICE error and needed to restart negotiation, you might have done something like this:</p>
<div class="code-example"><pre class="brush: js example-bad notranslate"><code>pc<span class="token punctuation">.</span><span class="token function-variable function">onnegotiationneeded</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  signaler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">description</span><span class="token operator">:</span> pc<span class="token punctuation">.</span>localDescription <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
pc<span class="token punctuation">.</span><span class="token function-variable function">oniceconnectionstatechange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pc<span class="token punctuation">.</span>iceConnectionState <span class="token operator">===</span> <span class="token string">"failed"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pc<span class="token punctuation">.</span><span class="token function">onnegotiationneeded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">iceRestart</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p>This has a number of reliability issues and outright bugs (such as failing if the <a href="../RTCPeerConnection/iceconnectionstatechange_event.html" title="iceconnectionstatechange"><code>iceconnectionstatechange</code></a> event fires when the signaling state isn't <code>stable</code>), but there was no way you could actually request an ICE restart other than by creating and sending an offer with the <code>iceRestart</code> option set to <code>true</code>. Sending the restart request thus required directly invoking the <code>negotiationneeded</code> event's handler. Getting it right was tricky at best, and was so easy to get wrong that bugs are common.</p>
<h4 id="using_restartice">Using restartIce()</h4>
<p>Now, you can use <code>restartIce()</code> to do this much more cleanly:</p>
<div class="code-example"><pre class="brush: js example-good notranslate"><code><span class="token keyword">let</span> makingOffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

pc<span class="token punctuation">.</span><span class="token function-variable function">onnegotiationneeded</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    makingOffer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    signaler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">description</span><span class="token operator">:</span> pc<span class="token punctuation">.</span>localDescription <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    makingOffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
pc<span class="token punctuation">.</span><span class="token function-variable function">oniceconnectionstatechange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pc<span class="token punctuation">.</span>iceConnectionState <span class="token operator">===</span> <span class="token string">"failed"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pc<span class="token punctuation">.</span><span class="token function">restartIce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p>With this improved technique, instead of directly calling <code>onnegotiationneeded</code> with options to trigger ICE restart, the <code>failed</code> <a href="../RTCPeerConnection/iceConnectionState.html">ICE connection state</a> calls <a href="../RTCPeerConnection/restartIce.html" title="restartIce()"><code>restartIce()</code></a>. <code>restartIce()</code> tells the ICE layer to automatically add the <code>iceRestart</code> flag to the next ICE message sent. Problem solved!</p></div></section><section aria-labelledby="rollback_no_longer_supported_in_the_pranswer_state"><h3 id="rollback_no_longer_supported_in_the_pranswer_state"><a href="#rollback_no_longer_supported_in_the_pranswer_state">Rollback no longer supported in the pranswer state</a></h3><div class="section-content"><p>The last of the API changes that stand out is that you can no longer roll back when in either of the <code>have-remote-pranswer</code> or the <code>have-local-pranswer</code> states. Fortunately, when using perfect negotiation there's no need to do this anyway, since the situations that cause this are caught and prevented before rolling these back ever becomes necessary.</p>
<p>Thus, attempting to trigger rollback while in one of the two <code>pranswer</code> states will now throw an <code>InvalidStateError</code>.</p></div></section><section aria-labelledby="see_also"><a class="dashAnchor" name="//apple_ref/Section/See%20also"></a><h2 id="see_also"><a href="#see_also">See also</a></h2><div class="section-content"><ul>
  <li><a href="../WebRTC_API.html">WebRTC API</a></li>
  <li><a href="Session_lifetime.html">Lifetime of a WebRTC session</a></li>
</ul></div></section><aside class="metadata"><div class="metadata-content-container"><div id="on-github" class="on-github"><h3>Found a content problem with this page?</h3><ul><li>Edit the page <a href="https://github.com/mdn/content/edit/main/files/en-us/web/api/webrtc_api/perfect_negotiation/index.md" title="This will take you to GitHub, where you'll need to sign in first." target="_blank" rel="noopener noreferrer">on GitHub</a>.</li><li>Report the <a href="https://github.com/mdn/content/issues/new?template=page-report.yml&amp;mdn-url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWebRTC_API%2FPerfect_negotiation&amp;metadata=%3C%21--+Do+not+make+changes+below+this+line+--%3E%0A%3Cdetails%3E%0A%3Csummary%3EPage+report+details%3C%2Fsummary%3E%0A%0A*+Folder%3A+%60en-us%2Fweb%2Fapi%2Fwebrtc_api%2Fperfect_negotiation%60%0A*+MDN+URL%3A+https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWebRTC_API%2FPerfect_negotiation%0A*+GitHub+URL%3A+https%3A%2F%2Fgithub.com%2Fmdn%2Fcontent%2Fblob%2Fmain%2Ffiles%2Fen-us%2Fweb%2Fapi%2Fwebrtc_api%2Fperfect_negotiation%2Findex.md%0A*+Last+commit%3A+https%3A%2F%2Fgithub.com%2Fmdn%2Fcontent%2Fcommit%2F3f7036e4dbe83e50c873c42a88a5a7d1d80a478e%0A*+Document+last+modified%3A+2022-11-25T08%3A33%3A02.000Z%0A%0A%3C%2Fdetails%3E" title="This will take you to GitHub to file a new issue." target="_blank" rel="noopener noreferrer">content issue</a>.</li><li>View the source <a href="https://github.com/mdn/content/blob/main/files/en-us/web/api/webrtc_api/perfect_negotiation/index.md?plain=1" title="Folder: en-us/web/api/webrtc_api/perfect_negotiation (Opens in a new tab)" target="_blank" rel="noopener noreferrer">on GitHub</a>.</li></ul>Want to get more involved? Learn<!-- --> <a href="https://github.com/mdn/content/blob/main/CONTRIBUTING.md" title="This will take you to our contribution guidelines on GitHub." target="_blank" rel="noopener noreferrer">how to contribute</a>.</div><p class="last-modified-date">This page was last modified on<!-- --> <time datetime="2022-11-25T08:33:02.000Z">Nov 25, 2022</time> by<!-- --> <a href="Perfect_negotiation/contributors.txt">MDN contributors</a>.</p></div></aside></article></main></div><footer id="nav-footer" class="page-footer"><div><a href="http://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Perfect_negotiation">Establishing a connection: The WebRTC perfect negotiation pattern</a> by <a href="http://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Perfect_negotiation$history">Mozilla Contributors</a> is licensed under <a href="http://creativecommons.org/licenses/by-sa/2.5/">CC-BY-SA 2.5</a>.</div></footer></div></div><script type="application/json" id="hydration">{"doc":{"isMarkdown":true,"isTranslated":false,"isActive":true,"flaws":{},"title":"Establishing a connection: The WebRTC perfect negotiation pattern","mdn_url":"/en-US/docs/Web/API/WebRTC_API/Perfect_negotiation","locale":"en-US","native":"English (US)","sidebarHTML":"<ol><li><strong><a href=\"/en-US/docs/Web/API/WebRTC_API\">WebRTC API</a></strong></li><li class=\"toggle\"><details open=\"\"><summary>Guides</summary><ol><li><a href=\"/en-US/docs/Web/API/WebRTC_API/Protocols\">Introduction to WebRTC protocols</a></li><li><a href=\"/en-US/docs/Web/API/WebRTC_API/Connectivity\">WebRTC connectivity</a></li><li><a href=\"/en-US/docs/Web/API/WebRTC_API/Session_lifetime\">Lifetime of a WebRTC session</a></li><li><a href=\"/en-US/docs/Web/API/WebRTC_API/Signaling_and_video_calling\">Signaling and video calling</a></li><li><a href=\"/en-US/docs/Web/API/WebRTC_API/Using_data_channels\">Using WebRTC data channels</a></li><li><a href=\"/en-US/docs/Web/API/WebRTC_API/Using_DTMF\">Using DTMF with WebRTC</a></li><li><a href=\"/en-US/docs/Web/API/WebRTC_API#interoperability\">WebRTC API</a></li><li><a href=\"/en-US/docs/Web/API/WebRTC_API/Simple_RTCDataChannel_sample\">A simple RTCDataChannel sample</a></li><li><a href=\"/en-US/docs/Web/API/WebRTC_API/Build_a_phone_with_peerjs\">Building an Internet-Connected Phone with PeerJS</a></li></ol></details></li><li class=\"toggle\"><details open=\"\"><summary>Interfaces</summary><ol><li><a href=\"/en-US/docs/Web/API/RTCPeerConnection\"><code>RTCPeerConnection</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCSessionDescription\"><code>RTCSessionDescription</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCIceCandidate\"><code>RTCIceCandidate</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnectionIceEvent\"><code>RTCPeerConnectionIceEvent</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnectionIceErrorEvent\"><code>RTCPeerConnectionIceErrorEvent</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCCertificate\"><code>RTCCertificate</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCRtpSender\"><code>RTCRtpSender</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCRtpReceiver\"><code>RTCRtpReceiver</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCRtpTransceiver\"><code>RTCRtpTransceiver</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDtlsTransport\"><code>RTCDtlsTransport</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCIceTransport\"><code>RTCIceTransport</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCTrackEvent\"><code>RTCTrackEvent</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCSctpTransport\"><code>RTCSctpTransport</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDataChannel\"><code>RTCDataChannel</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDataChannelEvent\"><code>RTCDataChannelEvent</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDTMFSender\"><code>RTCDTMFSender</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDTMFToneChangeEvent\"><code>RTCDTMFToneChangeEvent</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCStatsReport\"><code>RTCStatsReport</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCErrorEvent\"><code>RTCErrorEvent</code></a></li></ol></details></li><li class=\"toggle\"><details open=\"\"><summary>Properties</summary><ol><li><a href=\"/en-US/docs/Web/API/Navigator/mediaDevices\"><code>Navigator.mediaDevices</code></a></li></ol></details></li><li class=\"toggle\"><details open=\"\"><summary>Methods</summary><ol><li><a href=\"/en-US/docs/Web/API/MediaDevices/getUserMedia\"><code>MediaDevices.getUserMedia()</code></a></li></ol></details></li><li class=\"toggle\"><details open=\"\"><summary>Events</summary><ol><li><a href=\"/en-US/docs/Web/API/RTCDTMFSender/tonechange_event\"><code>RTCDTMFSender</code>: <code>tonechange</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDataChannel/bufferedamountlow_event\"><code>RTCDataChannel</code>: <code>bufferedamountlow</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDataChannel/close_event\"><code>RTCDataChannel</code>: <code>close</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDataChannel/closing_event\"><code>RTCDataChannel</code>: <code>closing</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDataChannel/error_event\"><code>RTCDataChannel</code>: <code>error</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDataChannel/message_event\"><code>RTCDataChannel</code>: <code>message</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDataChannel/open_event\"><code>RTCDataChannel</code>: <code>open</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDtlsTransport/error_event\"><code>RTCDtlsTransport</code>: <code>error</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCDtlsTransport/statechange_event\"><code>RTCDtlsTransport</code>: <code>statechange</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCIceTransport/error_event\"><code>RTCIceTransport</code>: <code>error</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCIceTransport/gatheringstatechange_event\"><code>RTCIceTransport</code>: <code>gatheringstatechange</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCIceTransport/selectedcandidatepairchange_event\"><code>RTCIceTransport</code>: <code>selectedcandidatepairchange</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCIceTransport/statechange_event\"><code>RTCIceTransport</code>: <code>statechange</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnection/connectionstatechange_event\"><code>RTCPeerConnection</code>: <code>connectionstatechange</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnection/datachannel_event\"><code>RTCPeerConnection</code>: <code>datachannel</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnection/icecandidate_event\"><code>RTCPeerConnection</code>: <code>icecandidate</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnection/icecandidateerror_event\"><code>RTCPeerConnection</code>: <code>icecandidateerror</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnection/iceconnectionstatechange_event\"><code>RTCPeerConnection</code>: <code>iceconnectionstatechange</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnection/icegatheringstatechange_event\"><code>RTCPeerConnection</code>: <code>icegatheringstatechange</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnection/negotiationneeded_event\"><code>RTCPeerConnection</code>: <code>negotiationneeded</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnection/signalingstatechange_event\"><code>RTCPeerConnection</code>: <code>signalingstatechange</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCPeerConnection/track_event\"><code>RTCPeerConnection</code>: <code>track</code></a></li><li><a href=\"/en-US/docs/Web/API/RTCSctpTransport/error_event\"><code>RTCSctpTransport</code>: <code>error</code></a></li></ol></details></li></ol>","body":[{"type":"prose","value":{"id":null,"title":null,"isH3":false,"content":"<p>This article introduces WebRTC <strong>perfect negotiation</strong>, describing how it works and why it's the recommended way to negotiate a WebRTC connection between peers, and provides sample code to demonstrate the technique.</p>\n<p>Because <a href=\"/en-US/docs/Web/API/WebRTC_API\">WebRTC</a> doesn't mandate a specific transport mechanism for signaling during the negotiation of a new peer connection, it's highly flexible. However, despite that flexibility in transport and communication of signaling messages, there's still a recommended design pattern you should follow when possible, known as perfect negotiation.</p>\n<p>After the first deployments of WebRTC-capable browsers, it was realized that parts of the negotiation process were more complicated than they needed to be for typical use cases. This was due to a small number of issues with the API and some potential race conditions that needed to be prevented. These issues have since been addressed, letting us simplify our WebRTC negotiation significantly. The perfect negotiation pattern is an example of the ways in which negotiation have improved since the early days of WebRTC.</p>"}},{"type":"prose","value":{"id":"perfect_negotiation_concepts","title":"Perfect negotiation concepts","isH3":false,"content":"<p>Perfect negotiation makes it possible to seamlessly and completely separate the negotiation process from the rest of your application's logic. Negotiation is an inherently asymmetric operation: one side needs to serve as the \"caller\" while the other peer is the \"callee.\" The perfect negotiation pattern smooths this difference away by separating that difference out into independent negotiation logic, so that your application doesn't need to care which end of the connection it is. As far as your application is concerned, it makes no difference whether you're calling out or receiving a call.</p>\n<p>The best thing about perfect negotiation is that the same code is used for both the caller and the callee, so there's no repetition or otherwise added levels of negotiation code to write.</p>\n<p>Perfect negotiation works by assigning each of the two peers a role to play in the negotiation process that's entirely separate from the WebRTC connection state:</p>\n<ul>\n  <li>A <strong>polite</strong> peer, which uses ICE rollback to prevent collisions with incoming offers. A polite peer, essentially, is one which may send out offers, but then responds if an offer arrives from the other peer with \"Okay, never mind, drop my offer and I'll consider yours instead.\"</li>\n  <li>An <strong>impolite</strong> peer, which always ignores incoming offers that collide with its own offers. It never apologizes or gives up anything to the polite peer. Any time a collision occurs, the impolite peer wins.</li>\n</ul>\n<p>This way, both peers know exactly what should happen if there are collisions between offers that have been sent. Responses to error conditions become far more predictable.</p>\n<p>How you determine which peer is polite and which is impolite is generally up to you. It could be as simple as assigning the polite role to the first peer to connect to the signaling server, or you could do something more elaborate like having the peers exchange random numbers and assigning the polite role to the winner. However you make the determination, once these roles are assigned to the two peers, they can then work together to manage signaling in a way that doesn't deadlock and doesn't require a lot of extra code to manage.</p>\n<p>An important thing to keep in mind is this: the roles of caller and callee can switch during perfect negotiation. If the polite peer is the caller and it sends an offer but there's a collision with the impolite peer, the polite peer drops its offer and instead replies to the offer it has received from the impolite peer. By doing so, the polite peer has switched from being the caller to the callee!</p>"}},{"type":"prose","value":{"id":"implementing_perfect_negotiation","title":"Implementing perfect negotiation","isH3":false,"content":"<p>Let's take a look at an example that implements the perfect negotiation pattern. The code assumes that there's a <code>SignalingChannel</code> class defined that is used to communicate with the signaling server. Your own code, of course, can use any signaling technique you like.</p>\n<p>Note that this code is identical for both peers involved in the connection.</p>"}},{"type":"prose","value":{"id":"create_the_signaling_and_peer_connections","title":"Create the signaling and peer connections","isH3":true,"content":"<p>First, the signaling channel needs to be opened and the <a href=\"/en-US/docs/Web/API/RTCPeerConnection\"><code>RTCPeerConnection</code></a> needs to be created. The <a href=\"/en-US/docs/Glossary/STUN\">STUN</a> server listed here is obviously not a real one; you'll need to replace <code>stun.myserver.tld</code> with the address of a real STUN server.</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">iceServers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">urls</span><span class=\"token operator\">:</span> <span class=\"token string\">\"stun:stun.mystunserver.tld\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> signaler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SignalingChannel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> pc <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RTCPeerConnection</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>This code also gets the <a href=\"/en-US/docs/Web/HTML/Element/video\"><code>&lt;video&gt;</code></a> elements using the classes \"selfview\" and \"remoteview\"; these will contain, respectively, the local user's self-view and the view of the incoming stream from the remote peer.</p>"}},{"type":"prose","value":{"id":"connecting_to_a_remote_peer","title":"Connecting to a remote peer","isH3":true,"content":"<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">const</span> constraints <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">audio</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">video</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> selfVideo <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"video.selfview\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> remoteVideo <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"video.remoteview\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> navigator<span class=\"token punctuation\">.</span>mediaDevices<span class=\"token punctuation\">.</span><span class=\"token function\">getUserMedia</span><span class=\"token punctuation\">(</span>constraints<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> track <span class=\"token keyword\">of</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">getTracks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      pc<span class=\"token punctuation\">.</span><span class=\"token function\">addTrack</span><span class=\"token punctuation\">(</span>track<span class=\"token punctuation\">,</span> stream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    selfVideo<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> stream<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The <code>start()</code> function shown above can be called by either of the two end-points that want to talk to one another. It doesn't matter who does it first; the negotiation will just work.</p>\n<p>This isn't appreciably different from older WebRTC connection establishment code. The user's camera and microphone are obtained by calling <a href=\"/en-US/docs/Web/API/MediaDevices/getUserMedia\" title=\"getUserMedia()\"><code>getUserMedia()</code></a>. The resulting media tracks are then added to the <a href=\"/en-US/docs/Web/API/RTCPeerConnection\"><code>RTCPeerConnection</code></a> by passing them into <a href=\"/en-US/docs/Web/API/RTCPeerConnection/addTrack\" title=\"addTrack()\"><code>addTrack()</code></a>. Then, finally, the media source for the self-view <a href=\"/en-US/docs/Web/HTML/Element/video\"><code>&lt;video&gt;</code></a> element indicated by the <code>selfVideo</code> constant is set to the camera and microphone stream, allowing the local user to see what the other peer sees.</p>"}},{"type":"prose","value":{"id":"handling_incoming_tracks","title":"Handling incoming tracks","isH3":true,"content":"<p>We next need to set up a handler for <a href=\"/en-US/docs/Web/API/RTCPeerConnection/track_event\" title=\"track\"><code>track</code></a> events to handle inbound video and audio tracks that have been negotiated to be received by this peer connection. To do this, we implement the <a href=\"/en-US/docs/Web/API/RTCPeerConnection\"><code>RTCPeerConnection</code></a>'s <a href=\"/en-US/docs/Web/API/RTCPeerConnection/track_event\" title=\"ontrack\"><code>ontrack</code></a> event handler.</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">ontrack</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> track<span class=\"token punctuation\">,</span> streams <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  track<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onunmute</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>remoteVideo<span class=\"token punctuation\">.</span>srcObject<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    remoteVideo<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> streams<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>When the <code>track</code> event occurs, this handler executes. Using <a href=\"/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment\">destructuring</a>, the <a href=\"/en-US/docs/Web/API/RTCTrackEvent\"><code>RTCTrackEvent</code></a>'s <a href=\"/en-US/docs/Web/API/RTCTrackEvent/track\" title=\"track\"><code>track</code></a> and <a href=\"/en-US/docs/Web/API/RTCTrackEvent/streams\" title=\"streams\"><code>streams</code></a> properties are extracted. The former is either the video track or the audio track being received. The latter is an array of <a href=\"/en-US/docs/Web/API/MediaStream\"><code>MediaStream</code></a> objects, each representing a stream containing this track (a track may in rare cases belong to multiple streams at once). In our case, this will always contain one stream, at index 0, because we passed one stream into <code>addTrack()</code> earlier.</p>\n<p>We add an unmute event handler to the track, because the track will become unmuted once it starts receiving packets. We put the remainder of our reception code in there.</p>\n<p>If we already have video coming in from the remote peer (which we can see if the remote view's <code>&lt;video&gt;</code> element's <a href=\"/en-US/docs/Web/API/HTMLMediaElement/srcObject\" title=\"srcObject\"><code>srcObject</code></a> property already has a value), we do nothing. Otherwise, we set <code>srcObject</code> to the stream at index 0 in the <code>streams</code> array.</p>"}},{"type":"prose","value":{"id":"the_perfect_negotiation_logic","title":"The perfect negotiation logic","isH3":true,"content":"<p>Now we get into the true perfect negotiation logic, which functions entirely independently from the rest of the application.</p>\n<h4 id=\"handling_the_negotiationneeded_event\">Handling the negotiationneeded event</h4>\n<p>First, we implement the <a href=\"/en-US/docs/Web/API/RTCPeerConnection\"><code>RTCPeerConnection</code></a> event handler <a href=\"/en-US/docs/Web/API/RTCPeerConnection/negotiationneeded_event\" title=\"onnegotiationneeded\"><code>onnegotiationneeded</code></a> to get a local description and send it using the signaling channel to the remote peer.</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">let</span> makingOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\npc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onnegotiationneeded</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    makingOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    signaler<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">description</span><span class=\"token operator\">:</span> pc<span class=\"token punctuation\">.</span>localDescription <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    makingOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>Note that <code>setLocalDescription()</code> without arguments automatically creates and sets the appropriate description based on the current <a href=\"/en-US/docs/Web/API/RTCPeerConnection/signalingState\" title=\"signalingState\"><code>signalingState</code></a>. The set description is either an answer to the most recent offer from the remote peer <em>or</em> a freshly-created offer if there's no negotiation underway. Here, it will always be an <code>offer</code>, because the negotiationneeded event is only fired in <code>stable</code> state.</p>\n<p>We set a Boolean variable, <code>makingOffer</code> to <code>true</code> to mark that we're preparing an offer. To avoid races, we'll use this value later instead of the signaling state to determine whether or not an offer is being processed because the value of <a href=\"/en-US/docs/Web/API/RTCPeerConnection/signalingState\" title=\"signalingState\"><code>signalingState</code></a> changes asynchronously, introducing a glare opportunity.</p>\n<p>Once the offer has been created, set and sent (or an error occurs), <code>makingOffer</code> gets set back to <code>false</code>.</p>\n<h4 id=\"handling_incoming_ice_candidates\">Handling incoming ICE candidates</h4>\n<p>Next, we need to handle the <code>RTCPeerConnection</code> event <a href=\"/en-US/docs/Web/API/RTCPeerConnection/icecandidate_event\" title=\"icecandidate\"><code>icecandidate</code></a>, which is how the local ICE layer passes candidates to us for delivery to the remote peer over the signaling channel.</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onicecandidate</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> candidate <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> signaler<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> candidate <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>This takes the <code>candidate</code> member of this ICE event and passes it through to the signaling channel's <code>send()</code> method to be sent over the signaling server to the remote peer.</p>\n<h4 id=\"handling_incoming_messages_on_the_signaling_channel\">Handling incoming messages on the signaling channel</h4>\n<p>The last piece of the puzzle is code to handle incoming messages from the signaling server. That's implemented here as an <code>onmessage</code> event handler on the signaling channel object. This method is invoked each time a message arrives from the signaling server.</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">let</span> ignoreOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\nsignaler<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> description<span class=\"token punctuation\">,</span> candidate <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> offerCollision <span class=\"token operator\">=</span>\n        description<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"offer\"</span> <span class=\"token operator\">&amp;&amp;</span>\n        <span class=\"token punctuation\">(</span>makingOffer <span class=\"token operator\">||</span> pc<span class=\"token punctuation\">.</span>signalingState <span class=\"token operator\">!==</span> <span class=\"token string\">\"stable\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      ignoreOffer <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>polite <span class=\"token operator\">&amp;&amp;</span> offerCollision<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ignoreOffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setRemoteDescription</span><span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"offer\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        signaler<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">description</span><span class=\"token operator\">:</span> pc<span class=\"token punctuation\">.</span>localDescription <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>candidate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">addIceCandidate</span><span class=\"token punctuation\">(</span>candidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ignoreOffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>Upon receiving an incoming message from the <code>SignalingChannel</code> through its <code>onmessage</code> event handler, the received JSON object is destructured to obtain the <code>description</code> or <code>candidate</code> found within. If the incoming message has a <code>description</code>, it's either an offer or an answer sent by the other peer.</p>\n<p>If, on the other hand, the message has a <code>candidate</code>, it's an ICE candidate received from the remote peer as part of <a href=\"/en-US/docs/Web/API/RTCPeerConnection/canTrickleIceCandidates\">trickle ICE</a>. The candidate is destined to be delivered to the local ICE layer by passing it into <a href=\"/en-US/docs/Web/API/RTCPeerConnection/addIceCandidate\" title=\"addIceCandidate()\"><code>addIceCandidate()</code></a>.</p>\n<h5 id=\"on_receiving_a_description\">On receiving a description</h5>\n<p>If we received a <code>description</code>, we prepare to respond to the incoming offer or answer. First, we check to make sure we're in a state in which we can accept an offer. If the connection's signaling state isn't <code>stable</code> or if our end of the connection has started the process of making its own offer, then we need to look out for offer collision.</p>\n<p>If we're the impolite peer, and we're receiving a colliding offer, we return without setting the description, and instead set <code>ignoreOffer</code> to <code>true</code> to ensure we also ignore all candidates the other side may be sending us on the signaling channel belonging to this offer. Doing so avoids error noise since we never informed our side about this offer.</p>\n<p>If we're the polite peer, and we're receiving a colliding offer, we don't need to do anything special, because our existing offer will automatically be rolled back in the next step.</p>\n<p>Having ensured that we want to accept the offer, we set the remote description to the incoming offer by calling <a href=\"/en-US/docs/Web/API/RTCPeerConnection/setRemoteDescription\" title=\"setRemoteDescription()\"><code>setRemoteDescription()</code></a>. This lets WebRTC know what the proposed configuration of the other peer is. If we're the polite peer, we will drop our offer and accept the new one.</p>\n<p>If the newly-set remote description is an offer, we ask WebRTC to select an appropriate local configuration by calling the <a href=\"/en-US/docs/Web/API/RTCPeerConnection\"><code>RTCPeerConnection</code></a> method <a href=\"/en-US/docs/Web/API/RTCPeerConnection/setLocalDescription\" title=\"setLocalDescription()\"><code>setLocalDescription()</code></a> without parameters. This causes <code>setLocalDescription()</code> to automatically generate an appropriate answer in response to the received offer. Then we send the answer through the signaling channel back to the first peer.</p>\n<h5 id=\"on_receiving_an_ice_candidate\">On receiving an ICE candidate</h5>\n<p>On the other hand, if the received message contains an ICE candidate, we deliver it to the local <a href=\"/en-US/docs/Glossary/ICE\">ICE</a> layer by calling the <a href=\"/en-US/docs/Web/API/RTCPeerConnection\"><code>RTCPeerConnection</code></a> method <a href=\"/en-US/docs/Web/API/RTCPeerConnection/addIceCandidate\" title=\"addIceCandidate()\"><code>addIceCandidate()</code></a>. If an error occurs and we've ignored the most recent offer, we also ignore any error that may occur when trying to add the candidate.</p>"}},{"type":"prose","value":{"id":"making_negotiation_perfect","title":"Making negotiation perfect","isH3":false,"content":"<p>If you're curious what makes perfect negotiation <em>so perfect</em>, this section is for you. Here, we'll look at each change made to the WebRTC API and to best practice recommendations to make perfect negotiation possible.</p>"}},{"type":"prose","value":{"id":"glare-free_setlocaldescription","title":"Glare-free setLocalDescription()","isH3":true,"content":"<p>In the past, the <a href=\"/en-US/docs/Web/API/RTCPeerConnection/negotiationneeded_event\" title=\"negotiationneeded\"><code>negotiationneeded</code></a> event was easily handled in a way that was susceptible to glare—that is, it was prone to collisions, where both peers could wind up attempting to make an offer at the same time, leading to one or the other peers getting an error and aborting the connection attempt.</p>\n<h4 id=\"the_old_way\">The old way</h4>\n<p>Consider this <a href=\"/en-US/docs/Web/API/RTCPeerConnection/negotiationneeded_event\" title=\"onnegotiationneeded\"><code>onnegotiationneeded</code></a> event handler:</p>\n<div class=\"code-example\"><pre class=\"brush: js example-bad notranslate\"><code>pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onnegotiationneeded</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">createOffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    signaler<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">description</span><span class=\"token operator\">:</span> pc<span class=\"token punctuation\">.</span>localDescription <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>Because the <a href=\"/en-US/docs/Web/API/RTCPeerConnection/createOffer\" title=\"createOffer()\"><code>createOffer()</code></a> method is asynchronous and takes some time to complete, there's time in which the remote peer might attempt to send an offer of its own, causing us to leave the <code>stable</code> state and enter the <code>have-remote-offer</code> state, which means we are now waiting for a response to the offer. But once it receives the offer we just sent, so is the remote peer. This leaves both peers in a state in which the connection attempt cannot be completed.</p>\n<h4 id=\"perfect_negotiation_with_the_updated_api\">Perfect negotiation with the updated API</h4>\n<p>As shown in the section <a href=\"#implementing_perfect_negotiation\">Implementing perfect negotiation</a>, we can eliminate this problem by introducing a variable (here called <code>makingOffer</code>) which we use to indicate that we are in the process of sending an offer, and making use of the updated <code>setLocalDescription()</code> method:</p>\n<div class=\"code-example\"><pre class=\"brush: js example-good notranslate\"><code><span class=\"token keyword\">let</span> makingOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\npc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onnegotiationneeded</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    makingOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    signaler<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">description</span><span class=\"token operator\">:</span> pc<span class=\"token punctuation\">.</span>localDescription <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    makingOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>We set <code>makingOffer</code> immediately before calling <code>setLocalDescription()</code> in order to lock against interfering with sending this offer, and we don't clear it back to <code>false</code> until the offer has been sent to the signaling server (or an error has occurred, preventing the offer from being made). This way, we avoid the risk of offers colliding.</p>"}},{"type":"prose","value":{"id":"automatic_rollback_in_setremotedescription","title":"Automatic rollback in setRemoteDescription()","isH3":true,"content":"<p>A key component to perfect negotiation is the concept of the polite peer, which always rolls itself back if it receives an offer while itself waiting for an answer to an offer. Previously, triggering rollback involved manually checking for rollback conditions and triggering the rollback manually, by setting the local description to one with the type <code>rollback</code>, like this:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rollback\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>Doing so returns the local peer to the <code>stable</code> <a href=\"/en-US/docs/Web/API/RTCPeerConnection/signalingState\" title=\"signalingState\"><code>signalingState</code></a> from whichever state it had previously been in. Since a peer can only accept offers when in the <code>stable</code> state, the peer has thus rescinded its offer and is ready to receive the offer from the remote (impolite) peer. As we'll see in a moment, there are problems with this approach, however.</p>\n<h4 id=\"perfect_negotiation_with_the_old_api\">Perfect negotiation with the old API</h4>\n<p>Using the previous API to implement incoming negotiation messages during perfect negotiation would look something like this:</p>\n<div class=\"code-example\"><pre class=\"brush: js example-bad notranslate\"><code>signaler<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> description<span class=\"token punctuation\">,</span> candidate <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"offer\"</span> <span class=\"token operator\">&amp;&amp;</span> pc<span class=\"token punctuation\">.</span>signalingState <span class=\"token operator\">!==</span> <span class=\"token string\">\"stable\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>polite<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n          pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rollback\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          pc<span class=\"token punctuation\">.</span><span class=\"token function\">setRemoteDescription</span><span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setRemoteDescription</span><span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"offer\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">createAnswer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        signaler<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">description</span><span class=\"token operator\">:</span> pc<span class=\"token punctuation\">.</span>localDescription <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>candidate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">addIceCandidate</span><span class=\"token punctuation\">(</span>candidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ignoreOffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>Since rollback works by postponing changes until the next negotiation (which will begin immediately after the current one is finished), the polite peer needs to know when it needs to throw away a received offer if it's currently waiting for a reply to an offer it's already sent.</p>\n<p>The code checks to see if the message is an offer, and if so, if the local signaling state isn't <code>stable</code>. If it's not stable, <em>and</em> the local peer is the polite one, we need to trigger rollback so we can replace the outgoing offer with the new incoming one. And these must both be completed before we can proceed with handling the received offer.</p>\n<p>Since there isn't a single \"roll back and use this offer instead\", performing this change on the polite peer requires two steps, executed in the context of <a href=\"/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all\"><code>Promise.all()</code></a>, which is used to ensure that both statements execute completely before continuing to handle the received offer. The first statement triggers rollback and the second sets the remote description to the received one, thus completing the process of replacing the previously <em>sent</em> offer with the newly <em>received</em> offer. The impolite peer has now become the callee instead of the caller.</p>\n<p>All other descriptions received from the impolite peer are processed as normal, by passing them into <a href=\"/en-US/docs/Web/API/RTCPeerConnection/setRemoteDescription\" title=\"setRemoteDescription()\"><code>setRemoteDescription()</code></a>.</p>\n<p>Finally, we process a received offer by calling <code>setLocalDescription()</code> to set our local description to the one returned by <a href=\"/en-US/docs/Web/API/RTCPeerConnection/createAnswer\" title=\"createAnswer()\"><code>createAnswer()</code></a>. Then that gets sent to the polite peer using the signaling channel.</p>\n<p>If the incoming message is an ICE candidate rather than an SDP description, it's delivered to the ICE layer by passing it into the <a href=\"/en-US/docs/Web/API/RTCPeerConnection\"><code>RTCPeerConnection</code></a> method <a href=\"/en-US/docs/Web/API/RTCPeerConnection/addIceCandidate\" title=\"addIceCandidate()\"><code>addIceCandidate()</code></a>. If an error occurs here and we didn't just discard an offer due to being the impolite peer during a collision, we <a href=\"/en-US/docs/Web/JavaScript/Reference/Statements/throw\"><code>throw</code></a> the error so the caller can handle it. Otherwise, we drop the error, ignoring it, since it doesn't matter in this context.</p>\n<h4 id=\"perfect_negotiation_with_the_updated_api_2\">Perfect negotiation with the updated API</h4>\n<p>The updated code takes advantage of the fact that you can now call <a href=\"/en-US/docs/Web/API/RTCPeerConnection/setLocalDescription\" title=\"setLocalDescription()\"><code>setLocalDescription()</code></a> with no parameters so it just does the right thing for you, as well as the fact that <code>setRemoteDescription()</code> automatically rolls back if necessary. This lets us get rid of the need to use a <a href=\"/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise\"><code>Promise</code></a> to keep the timing in order, since the rollback becomes an essentially atomic part of the <code>setRemoteDescription()</code> call.</p>\n<div class=\"code-example\"><pre class=\"brush: js example-good notranslate\"><code><span class=\"token keyword\">let</span> ignoreOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\nsignaler<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> description<span class=\"token punctuation\">,</span> candidate <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> offerCollision <span class=\"token operator\">=</span>\n        description<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"offer\"</span> <span class=\"token operator\">&amp;&amp;</span>\n        <span class=\"token punctuation\">(</span>makingOffer <span class=\"token operator\">||</span> pc<span class=\"token punctuation\">.</span>signalingState <span class=\"token operator\">!==</span> <span class=\"token string\">\"stable\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      ignoreOffer <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>polite <span class=\"token operator\">&amp;&amp;</span> offerCollision<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ignoreOffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setRemoteDescription</span><span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"offer\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        signaler<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">description</span><span class=\"token operator\">:</span> pc<span class=\"token punctuation\">.</span>localDescription <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>candidate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">addIceCandidate</span><span class=\"token punctuation\">(</span>candidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ignoreOffer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>While the difference in code size is minor, and the complexity isn't reduced much either, the code is much, much more reliable. Let's take a dive into the code to see how it works now.</p>\n<h5 id=\"on_receiving_a_description_2\">On receiving a description</h5>\n<p>In the revised code, if the received message is an SDP <code>description</code>, we check to see if it arrived while we're attempting to transmit an offer. If the received message is an <code>offer</code> <em>and</em> the local peer is the impolite peer, <em>and</em> a collision is occurring, we ignore the offer because we want to continue to try to use the offer that's already in the process of being sent. That's the impolite peer in action.</p>\n<p>In any other case, we'll try instead to handle the incoming message. This begins by setting the remote description to the received <code>description</code> by passing it into <a href=\"/en-US/docs/Web/API/RTCPeerConnection/setRemoteDescription\" title=\"setRemoteDescription()\"><code>setRemoteDescription()</code></a>. This works regardless of whether we're handling an offer or an answer since rollback will be performed automatically as needed.</p>\n<p>At that point, if the received message is an <code>offer</code>, we use <code>setLocalDescription()</code> to create and set an appropriate local description, then we send it to the remote peer over the signaling server.</p>\n<h5 id=\"on_receiving_an_ice_candidate_2\">On receiving an ICE candidate</h5>\n<p>On the other hand, if the received message is an ICE candidate—indicated by the JSON object containing a <code>candidate</code> member—we deliver it to the local ICE layer by calling the <a href=\"/en-US/docs/Web/API/RTCPeerConnection\"><code>RTCPeerConnection</code></a> method <a href=\"/en-US/docs/Web/API/RTCPeerConnection/addIceCandidate\" title=\"addIceCandidate()\"><code>addIceCandidate()</code></a>. Errors are, as before, ignored if we have just discarded an offer.</p>"}},{"type":"prose","value":{"id":"explicit_restartice_method_added","title":"Explicit restartIce() method added","isH3":true,"content":"<p>The techniques previously used to trigger an <a href=\"/en-US/docs/Web/API/WebRTC_API/Session_lifetime#ice_restart\">ICE restart</a> while handling the event <a href=\"/en-US/docs/Web/API/RTCPeerConnection/negotiationneeded_event\" title=\"negotiationneeded\"><code>negotiationneeded</code></a> have significant flaws. These flaws have made it difficult to safely and reliably trigger a restart during negotiation. The perfect negotiation improvements have fixed this by adding a new <a href=\"/en-US/docs/Web/API/RTCPeerConnection/restartIce\" title=\"restartIce()\"><code>restartIce()</code></a> method to <code>RTCPeerConnection</code>.</p>\n<h4 id=\"the_old_way_2\">The old way</h4>\n<p>In the past, if you encountered an ICE error and needed to restart negotiation, you might have done something like this:</p>\n<div class=\"code-example\"><pre class=\"brush: js example-bad notranslate\"><code>pc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onnegotiationneeded</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">createOffer</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  signaler<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">description</span><span class=\"token operator\">:</span> pc<span class=\"token punctuation\">.</span>localDescription <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\npc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">oniceconnectionstatechange</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pc<span class=\"token punctuation\">.</span>iceConnectionState <span class=\"token operator\">===</span> <span class=\"token string\">\"failed\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    pc<span class=\"token punctuation\">.</span><span class=\"token function\">onnegotiationneeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">iceRestart</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>This has a number of reliability issues and outright bugs (such as failing if the <a href=\"/en-US/docs/Web/API/RTCPeerConnection/iceconnectionstatechange_event\" title=\"iceconnectionstatechange\"><code>iceconnectionstatechange</code></a> event fires when the signaling state isn't <code>stable</code>), but there was no way you could actually request an ICE restart other than by creating and sending an offer with the <code>iceRestart</code> option set to <code>true</code>. Sending the restart request thus required directly invoking the <code>negotiationneeded</code> event's handler. Getting it right was tricky at best, and was so easy to get wrong that bugs are common.</p>\n<h4 id=\"using_restartice\">Using restartIce()</h4>\n<p>Now, you can use <code>restartIce()</code> to do this much more cleanly:</p>\n<div class=\"code-example\"><pre class=\"brush: js example-good notranslate\"><code><span class=\"token keyword\">let</span> makingOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\npc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onnegotiationneeded</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    makingOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> pc<span class=\"token punctuation\">.</span><span class=\"token function\">setLocalDescription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    signaler<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">description</span><span class=\"token operator\">:</span> pc<span class=\"token punctuation\">.</span>localDescription <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    makingOffer <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\npc<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">oniceconnectionstatechange</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pc<span class=\"token punctuation\">.</span>iceConnectionState <span class=\"token operator\">===</span> <span class=\"token string\">\"failed\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    pc<span class=\"token punctuation\">.</span><span class=\"token function\">restartIce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>With this improved technique, instead of directly calling <code>onnegotiationneeded</code> with options to trigger ICE restart, the <code>failed</code> <a href=\"/en-US/docs/Web/API/RTCPeerConnection/iceConnectionState\">ICE connection state</a> calls <a href=\"/en-US/docs/Web/API/RTCPeerConnection/restartIce\" title=\"restartIce()\"><code>restartIce()</code></a>. <code>restartIce()</code> tells the ICE layer to automatically add the <code>iceRestart</code> flag to the next ICE message sent. Problem solved!</p>"}},{"type":"prose","value":{"id":"rollback_no_longer_supported_in_the_pranswer_state","title":"Rollback no longer supported in the pranswer state","isH3":true,"content":"<p>The last of the API changes that stand out is that you can no longer roll back when in either of the <code>have-remote-pranswer</code> or the <code>have-local-pranswer</code> states. Fortunately, when using perfect negotiation there's no need to do this anyway, since the situations that cause this are caught and prevented before rolling these back ever becomes necessary.</p>\n<p>Thus, attempting to trigger rollback while in one of the two <code>pranswer</code> states will now throw an <code>InvalidStateError</code>.</p>"}},{"type":"prose","value":{"id":"see_also","title":"See also","isH3":false,"content":"<ul>\n  <li><a href=\"/en-US/docs/Web/API/WebRTC_API\">WebRTC API</a></li>\n  <li><a href=\"/en-US/docs/Web/API/WebRTC_API/Session_lifetime\">Lifetime of a WebRTC session</a></li>\n</ul>"}}],"toc":[{"text":"Perfect negotiation concepts","id":"perfect_negotiation_concepts"},{"text":"Implementing perfect negotiation","id":"implementing_perfect_negotiation"},{"text":"Making negotiation perfect","id":"making_negotiation_perfect"},{"text":"See also","id":"see_also"}],"summary":"This article introduces WebRTC perfect negotiation, describing how it works and why it's the recommended way to negotiate a WebRTC connection between peers, and provides sample code to demonstrate the technique.","popularity":0,"modified":"2022-11-25T08:33:02.000Z","source":{"folder":"en-us/web/api/webrtc_api/perfect_negotiation","github_url":"https://github.com/mdn/content/blob/main/files/en-us/web/api/webrtc_api/perfect_negotiation/index.md","last_commit_url":"https://github.com/mdn/content/commit/3f7036e4dbe83e50c873c42a88a5a7d1d80a478e","filename":"index.md"},"short_title":"Establishing a connection: The WebRTC perfect negotiation pattern","parents":[{"uri":"/en-US/docs/Web","title":"References"},{"uri":"/en-US/docs/Web/API","title":"Web APIs"},{"uri":"/en-US/docs/Web/API/WebRTC_API","title":"WebRTC API"},{"uri":"/en-US/docs/Web/API/WebRTC_API/Perfect_negotiation","title":"Establishing a connection: The WebRTC perfect negotiation pattern"}],"pageTitle":"Establishing a connection: The WebRTC perfect negotiation pattern - Web APIs | MDN","noIndexing":false}}</script>
<!-- Mirrored from developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Perfect_negotiation by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 14 Feb 2023 04:50:02 GMT -->
</body></html>